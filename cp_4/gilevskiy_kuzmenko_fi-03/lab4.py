from typing import List
import time

class LRZ:
    def __init__(self, recurrent_coefs, poly_deg):
        self.filling = 0
        self.mask_for_bit_to_pop = 1
        self.mask_for_bit_to_set = 0
        self.max_bit_n = poly_deg - 1
        self.recurrent_coefs = recurrent_coefs

        self.mask_for_bit_to_set = 1 << self.max_bit_n

    def generate_from_fill(self, filling, length):
        self.filling = filling
        feedback = []

        for _ in range(length):
            feedback.append(self.filling & self.mask_for_bit_to_pop)
            self.filling = (self.filling >> 1) ^ (((self.filling & self.recurrent_coefs).bit_count() & 1) << self.max_bit_n)

        return feedback

    
class GeffeGenerator:
    def __init__(self, lfsr1: LRZ, lfsr2: LRZ, lfsr3: LRZ):
        self.lfsr1 = lfsr1
        self.lfsr2 = lfsr2
        self.lfsr3 = lfsr3

    def generate(self, initial_lfsr1: int, initial_lfsr2: int, initial_lfsr3: int, length: int) -> List[int]:
        res = []
        x_seq = self.lfsr1.generate_from_fill(initial_lfsr1, length)
        y_seq = self.lfsr2.generate_from_fill(initial_lfsr2, length)
        s_seq = self.lfsr3.generate_from_fill(initial_lfsr3, length)

        for i in range(length):
            if s_seq[i] == 1:
                res.append(x_seq[i])
            else:
                res.append(y_seq[i])

        return res


dummy_variant = "10010110111100000100100000001111001100110110000010001111010111000110101010011001011000011001010101010000101100111000011110000110001000111111100101111010000011010011011110001000000110100101011110100000000111001010100101000011110111101110001001011010110011110001110101001111000101001001111010011010110011101010000010101010001011001101011100101010010111000011001010011010101011101011101001111000100001010110110001000011011101111000011101000111000101111101001000000010010001010101111010001010001001000001010110011111100010001001011011000011111000100010111100011000110000011110100111001110110010111111111110011011011100101100001000111100111000110001011001010000111111001100110100000111000011010010010011100111111000111000000010110001000101011001000011011011110111001000101100000100001010000100100110100010101000110010001101011110100110011001100011000011101011111101000010100101000110101011101011001100001110001111011000110000111011011101101101111011110100111101101001000010110001110110111111001110111011001011110010101110110000100001001011001101011111101001101101111101011000010011111000010010011101000100000001101101110110010000111100001011010110110011001000100000110111100001101100000001100100000010000111011110111000101011110011001011101101011001010110101101010101111111011110111101110100011001101101100111010010101011110000001010101001000001000111111011100000011000110110001010110010100101011010000011110101111101101001100100001101011100111000100011110000001010001000101010110110100001001110001101101000000110011000110000100001101010010011010101100011011111100000111110100100001000110000010111101110101101010101000001100000101111001000010111000010111000011111111111101001111101111100110011000011100110000001111010101101100010000111001100001001111010101101010100111110010000001010111000001001001001101111011000100010101011111010101011010111010111111110111011011000100011110001111011110011101011000001100010101110001001110001011101110110000010101010110101101011011001110110011110011000111111000011111011111010111011111000101100100100001110010100101100"
full_variant = "01101000110111011010110001010000010010011110100111011011110101001001001110101010100111000001011010011000100110101111100011000010111010011001101111101100001100110100100000011110010000001110011010010110111001100001110111101101001001100000000010000111101101000111110011000111100000001001011011100001010000101010001001000111000000111001011110111101010001110101110010110110001011100100001011011100111001001110111010100000001111001000001111010011110100111000010001101000000000100001011101000101011010001000110011001011001101001110001100010100011001010100111100111100011111101000110111111000011101110111010010010101111100001000100011101100010000000111110000001100011101110111110011101010110011101110000101111000010010100010001010111011010100100100010011101111111001100001010011000011001100010100110010000101001101100100111101010001000010001010000110010011011111011001101000110000110111011000011100110101001011111011101011011101000111101010011010110011101110010111100000101100010101011100111101000110101011011100010101011101110011101110010110011001111100010111000111101010101110011011000111111001111010001001100111011001001101001110100010011111010010001001010100111110100111001001100101001101111110101100011000110111000001000101010010001111011000001100001011110111111011110011110011111101001111101001010010001111001011010110110100010100100010010010111001010011110010100010100111001011110000011000110010100110010110110000100100100111110010101011101110001100100111000110001010010011000000010111111101011101110101101000101110011011000111110111000010011100100000111110111010100100010110100111001010101011000011011101000100101011011110101111011110011101111110110000110110001000010001010101010010001001000100001001011010000101110110001101001011100001000010000000001110001100110001010110100001110001000110000101011011101010010001011011000010000111000100001001100000111111001101110101100001011100001000011001011011101001101100010111011001011010000100001100010011000011111001001101111001011100101010111010010110111111001100111101111100001111000011000011010000110010"

string_len = 2048

start = time.time()

lfsr1_rec = ((1 << 3) ^ 1)
lfsr1_deg = 25
lfsr2_rec = ((1 << 6) ^ (1 << 2) ^ (1 << 1) ^ 1)
lfsr2_deg = 26
lfsr3_rec = ((1 << 5) ^ (1 << 2) ^ (1 << 1) ^ 1)
lfsr3_deg = 27

N = len(dummy_variant)
r_seq = [int(bit) for bit in dummy_variant]

N1_req = 222
C1 = 71
N2_req = 229
C2 = 74

lfsr1 = LRZ(lfsr1_rec, lfsr1_deg)
lfsr2 = LRZ(lfsr2_rec, lfsr2_deg)
lfsr3 = LRZ(lfsr3_rec, lfsr3_deg)

lfsr1_candidates = []
cyclen = (1 << lfsr1_deg) + N1_req
curr_candidate = 1
generated_seq = lfsr1.generate_from_fill(curr_candidate, cyclen)

for j in range(1 << lfsr1_deg):
    R = sum(generated_seq[j + i] ^ r_seq[i] for i in range(N1_req))
    if R < C1:
        lfsr1_candidates.append((curr_candidate, R))
    curr_candidate = (curr_candidate >> 1) ^ ((generated_seq[lfsr1_deg + j]) << (lfsr1_deg - 1))

print("L1 ", len(lfsr1_candidates), " кандидатів")

lfsr2_candidates = []
cyclen = (1 << lfsr2_deg) + N2_req
curr_candidate = 1
generated_seq = lfsr2.generate_from_fill(curr_candidate, cyclen)

for j in range(1 << lfsr2_deg):
    R = sum(generated_seq[j + i] ^ r_seq[i] for i in range(N2_req))
    if R < C2:
        lfsr2_candidates.append((curr_candidate, R))
    curr_candidate = (curr_candidate >> 1) ^ ((generated_seq[lfsr2_deg + j]) << (lfsr2_deg - 1))

print("L2 ", len(lfsr2_candidates), " кандидатів")

lfsr1_candidate = 0
lfsr2_candidate = 0
lfsr3_candidate = 0

best_candidate_lfsr1 = lfsr1_candidates[0][0]
min_deviation = lfsr1_candidates[0][1] - 0.25 * N1_req
for b, R in lfsr1_candidates:
    deviation = R - 0.25 * N1_req
    if deviation < min_deviation:
        best_candidate_lfsr1 = b
        min_deviation = deviation

best_candidate_lfsr2 = lfsr2_candidates[0][0]
min_deviation = lfsr2_candidates[0][1] - 0.25 * N2_req
for b, R in lfsr2_candidates:
    deviation = R - 0.25 * N2_req
    if deviation < min_deviation:
        best_candidate_lfsr2 = b
        min_deviation = deviation

cyclen = (1 << lfsr3_deg) + N
curr_candidate = 1
lfsr3_seq = lfsr3.generate_from_fill(curr_candidate, cyclen)

lfsr1_seq = lfsr1.generate_from_fill(best_candidate_lfsr1, N)

lfsr2_seq = lfsr2.generate_from_fill(best_candidate_lfsr2, N)

for j in range(1 << lfsr3_deg):
    found = True
    for l3, l1, l2, r in zip(lfsr3_seq[j:], lfsr1_seq, lfsr2_seq, r_seq):
        if ((l3 & l1) ^ ((1 ^ l3) & l2)) != r:
            found = False
            break

    if found:
        lfsr1_candidate = best_candidate_lfsr1
        lfsr2_candidate = best_candidate_lfsr2
        lfsr3_candidate = curr_candidate
        break

    curr_candidate = (curr_candidate >> 1) ^ ((lfsr3_seq[lfsr3_deg + j]) << (lfsr3_deg - 1))

print("L3")

print("\nL1 кандидат: ", lfsr1_candidate, bin(lfsr1_candidate))
print("L2 кандидат: ", lfsr2_candidate, bin(lfsr2_candidate))
print("L3 кандидат: ", lfsr3_candidate, bin(lfsr3_candidate))

print("Перевірка")
generator = GeffeGenerator(lfsr1, lfsr2, lfsr3)

test_gen = generator.generate(lfsr1_candidate, lfsr2_candidate, lfsr3_candidate, string_len)

print("Згенерована послідовність: ")
print("".join(str(bit) for bit in test_gen))

print("Очікувана послідовість:")
print(dummy_variant)

end = time.time()
execution_time = end - start
print("\nЧас виконання: ", execution_time, "секунд")
